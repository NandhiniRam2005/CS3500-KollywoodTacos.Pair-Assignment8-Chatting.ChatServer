@*// <copyright file="NetworkConnection.cs" company="UofU-CS3500">
  // Copyright (c) 2024 UofU-CS3500. All rights reserved.
  //
  </copyright>

  /// <summary>
  /// Author:    Joel Rodriguez,  Nandhini Ramanathan, and Professor Jim.
  /// Partner:   None
  /// Date:      November 1, 2024
  /// Course:    CS 3500, University of Utah, School of Computing
  /// Copyright: CS 3500 and [Joel Rodriguez and Nandhini Ramanathan] - This work may no
  ///            be copied for use in Academic Coursework.
  ///
  /// I, Joel Rodriguez and Nandhini Ramanathan, certify that I wrote this code from scratch and
  /// did not copy it in part or whole from another source.  All
  /// references used in the completion of the assignments are cited
  /// in my README file.
  ///
  /// File Contents
  ///     This sealed class encapsulates all the complex mechanics of a network connection. For example this class houses a StreamReader/Writer/Logger/
  ///     TcpClient. It provides methods to handle connecting and disconnecting from the server and methods for sending and receiving chat messages. 
  ///     It also manages a logger for various activities in the chatroom.
  /// </summary>
    *@

@page "/chatclient"
@rendermode InteractiveServer
@using CS3500.Networking
@using System.Text
@using Microsoft.Extensions.Logging.Abstractions
@inject ILogger<NetworkConnection> Logger;
@inject IJSRuntime JS;

<PageTitle>Chat Client</PageTitle>
<h1>Chat Client</h1>

<div id="ConnectionInputs">
    <div class="input-row">
        <label for="url"> Server Address: </label>
        <input id="url" disabled="@network.IsConnected" type="text" @bind="ServerNameOrAddress" />
        <label for="url"> Port: </label>
        <input id="port" disabled="@network.IsConnected" type="number" @bind="ServerPort" class="port" />
        @if ( network.IsConnected )
        {
            <button class="btn btn-primary" @onclick="DisconnectFromServer">Disconnect</button>
        }
        else
        {
            <button class="btn btn-primary" @onclick="ConnectToServer">Connect</button>
        }
    </div>


    @{
        bool disconnected = !network.IsConnected;
        string grayedOut = disconnected ? "grayedOut" : string.Empty;
    }

    <div class="input-row">
        <label for="message"> Chat: </label>
        <input id="message" class="@grayedOut" disabled="@(disconnected)" type="text" @onchange="HandleSendMessage" />
    </div>
    <div class="input-row">
        <div class="input-col">
            <div id="Messages" class="container @grayedOut">
                @foreach ( var line in AllMessages )
                {
                    <span class="themClass">
                        @line
                    </span>
                }

            </div>
        </div>
    </div>
</div>


@code
{
    /// <summary>
    /// Default server name.
    /// </summary>
    private string ServerNameOrAddress = "localhost";

    /// <summary>
    /// Default server port.
    /// </summary>
    private int ServerPort = 11000;

    /// <summary>
    /// The NetworkConnection object representing a connection with the server.
    /// </summary>
    private NetworkConnection network = null!;

    /// <summary>
    /// The string shown in the message display area, representing all messages seen.
    /// </summary>
    private string MessageDisplayTextAreaData
    {
        get
        {
            return string.Join( "\n", AllMessages );
        }
    }

    /// <summary>
    /// All of the messages seen by the server and displayed in the chatroom.
    /// </summary>
    private List<string> AllMessages = new();


    /// <summary>
    /// Disconnect the network object from the server.
    /// </summary>
    private void DisconnectFromServer()
    {
        network.Disconnect();
        Logger.LogInformation("A user has disconnected from the server.");
        network = new NetworkConnection(Logger);
    }

    /// <summary>
    /// Handler for the connect button
    /// Attempt to connect to the server, then start an asynchronous loop
    /// to receive and display messages.
    /// </summary>
    private void ConnectToServer()
    {
        try
        {
            Logger.LogDebug("Entering the Connect method");
            network.Connect( ServerNameOrAddress, ServerPort );
            Logger.LogDebug("Exited the connect method successfully.");
            Logger.LogInformation("A user has connected to the server.");

            // Communicating with the server needs to be asynchronous so that the UI thread 
            // can continue drawing.
            new Thread( () =>
            {
                while ( network.IsConnected )
                {
                    try
                    {
                        Logger.LogDebug("Entering the ReadLine method");
                        var message = network.ReadLine();
                        Logger.LogDebug("Exited the ReadLine method successfully");

                        message = $"{DateTime.Now:HH:mm tt} - {message}";
                        AllMessages.Insert( 0, message );

                        // Since we are changing the UI from another thread, we need to 
                        // use the dispatcher for StateHasChanged
                        InvokeAsync( () => StateHasChanged() );
                    }
                    catch
                    {
                        Logger.LogDebug("Entering the disconnect method");
                        network.Disconnect();
                        Logger.LogDebug("Exited the disconnect method successfully");
                        Logger.LogInformation("A user has disconnected from the chatroom.");
                    }
                }
            } ).Start();
        }
        catch
        {
        }

    }

    /// <summary>
    ///   When the user types a message and presses enter, send the message
    ///   to the server.
    /// </summary>
    /// <param name="e"> Event data containing the message. </param>
    private void HandleSendMessage( ChangeEventArgs e )
    {
        if ( e.Value != null )
        {
            Logger.LogDebug("Entering send method");
            network.Send( $"{e.Value}" );
            Logger.LogDebug("Exited send method successfully");
            Logger.LogInformation("A message has been sent "+$"{e.Value}");
        }
    }

    /// <summary>
    ///   Create/ Initializes a default network object
    /// </summary>
    protected override void OnInitialized()
    {
        Logger.LogInformation("Program Started");
        base.OnInitialized();
        network = new NetworkConnection(Logger);
    }

}
